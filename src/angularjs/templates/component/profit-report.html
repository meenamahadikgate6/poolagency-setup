<div class="profit-report-wrapper border-box" ng-show="canView" ng-init="getProfitReport()">    
    <success ng-if="successMsg" message="{{successMsg}}"></success>
    <error ng-if="error" message="{{error}}"></error>  
    
    <div  class="container-fluid white-bg p-tb20 p-lr20 report-sm-card-loader-parent">
      <div class="report-sm-card-loader" ng-if="isProcessingProfitBreakdownReport || isProcessingProfitBreakdownReportList">
        <div class="spinner">
           <div class="spinner-item">
              <div class="spinner-animation"><img border="0" src="resources/images/spinner.gif" /></div>
           </div>
        </div>
     </div>
      <div class="row">
        <div class="col-md-12">
          <label class="font-regular h-4x m-b20">Route Profit Breakdown</label>   
          <span class="excel-download-btn" ng-click="downloadProfitBreakdownReport()"></span> 
        </div>
      </div>

      
      <div class="row p-b20 m-b20">
        <div ng-if="isTechDetailPage" class="col-md-3"></div>
        <div class="col-md-6 text-left report-filter-box tech-report-filter-box">        
            <div class="select custom-select custom-select-noimage">
                <select ng-model="pageObj.filterMonth" ng-change="filterByDays(pageObj.filterMonth)" ng-options="x for x in pageObj.filterReportData"></select>
            </div> 
            <div>
              <div class="grid date-picker-wrapper" ng-hide="pageObj.filterMonth !='custom'">
                <div class="datePicker input-daterange input-daterange-include">
                  <div class="col-6-12 p-lr10 fl">
                    <div class="smallview fromDateView" date-format="MM/dd/yyyy">
                      <input ng-model="pageObj.fromDate" ng-click="clickDate($event)" type="text" class="angular-datepicker-input" placeholder="From Date" ng-change="filterByDate('pageObj.fromDate')" id="fromDateInputProfit"/>
                    </div>
                  </div>
                  <div class="col-6-12 m-l10 text-right fr">
                    <div class="" date-format="MM/dd/yyyy" min-date="pageObj.fromDate">
                      <input ng-model="pageObj.toDate" ng-click="clickDate($event)" type="text" class="angular-datepicker-input" placeholder="To Date"  ng-change="filterByDate('pageObj.toDate')" id="toDateInputProfit" />
                    </div>
                  </div>
                </div>
              </div> 
              <div class="flex" ng-show="pageObj.filterMonth !='custom'">
                <i class="fa fa-caret-left" aria-hidden="true" ng-click="changeMonth('prev')"></i>
                
                <span style="min-width: 127px;" class="text-center">{{pageObj.month | date:'MMMM yyyy'}}</span>                
                <i class="fa fa-caret-right" aria-hidden="true" ng-click="changeMonth('next')"></i>
              </div>
            </div>
        </div> 
    </div>
        <div class="fluid-container">
          
          <div class="row">
            <div class="col-md-5"> 
              <div class="chart-overlay" ng-if="lowProfitFocus"></div>
              <div class="bb text-center m-b10 acp-label h-1x">ACTIVE PROPERTIES</div>
              <div id="ACTIVEPROPERTYCHART" class="report-chart profit-report-chart " style="overflow: hidden;"></div>  
              <!--div class="reset-profit-filter" ng-if="pageObj.profitFilter"><a ng-click="filterByProfit('','reset')">Reset Filter</a></div-->
            </div>
            <div class="col-md-4">
              <div class="chart-overlay" ng-if="lowProfitFocus"></div>
              <div id="AVERAGEPROFITCHART" class="report-chart profit-report-chart"></div> 
              <div class="bb text-center m-b10 h-1x">AVERAGE PROFIT PER PROPERTY</div>
            </div>
            <div class="col-md-3 text-left h-1x">
              <div class="bb text-center m-b20">TOTALS</div>
              <div class="row small-padding m-b10 h-2x">
                <span class="col-sm-4">Invoiced</span><span class="col-sm-8 text-right bb light-blue">{{profitReportObj.invTotal | currency}}</span>
              </div>
              <div class="row small-padding m-b10 h-2x">
                <span class="col-sm-4">Cost</span><span class="col-sm-8 text-right bb light-blue">{{profitReportObj.costTotal | currency}}</span>
              </div>
              <div class="row small-padding m-b20 h-2x">
                <span class="col-sm-4">Profit</span><span class="col-sm-8 text-right bb light-blue">{{profitReportObj.profitTotal | currency}}</span>
              </div>
            </div>

          </div>
        </div>
      
        <div class="text-left p-l20 m-b10">
          <small >Low profit properties = less than <span class="input-percentage inline-block">
            <span>%</span>
            <input 
              class="form-control small-input input-number" 
              mgminmax-validator 
              type="number" 
              name="lowProfit" 
              id="lowProfit" 
              ng-model="model.lowProfit" 
              ng-min="1" 
              ng-max="99" 
              style="width: 70px; height:24px" 
              required 
              ng-blur="lowProfitUpdate(model.lowProfit); lowProfitFocus = false"
              allow-typing="^[0-9. ]+$"
              ng-keypress="lowProfitUpdateByEnter($event, model.lowProfit)"
              ng-focus="lowProfitFocus = true"
            />

          </span>  profit</small>
        </div>
        <div class="dataTables_wrapper profit-table">
          
            <div>
              <table class="row-border hover no-footer dataTable" width="100%">
                <thead class="dark-gray-bg">
                  <tr>
                    <th></th>
                    <th class="text-left" style="width: 20%!important;">
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('displayName')"
                          ng-class="{'sorting_asc': pageObj.column == 'displayName' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'displayName' && pageObj.dir == 'desc' }">
                        PROPERTY
                      </div>
                    </th>
                    <th>
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('totalAmount')"
                          ng-class="{'sorting_asc': pageObj.column == 'totalAmount' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'totalAmount' && pageObj.dir == 'desc' }">
                        INVOICED
                      </div>
                    </th>
                    <th>
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('chemSpend')"
                          ng-class="{'sorting_asc': pageObj.column == 'chemSpend' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'chemSpend' && pageObj.dir == 'desc' }">
                        CHEM SPEND
                      </div>
                    </th>
                    <th>
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('techPay')"
                          ng-class="{'sorting_asc': pageObj.column == 'techPay' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'techPay' && pageObj.dir == 'desc' }">
                        TECH PAY
                      </div>
                    </th>
                    <th>
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('profit')"
                          ng-class="{'sorting_asc': pageObj.column == 'profit' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'profit' && pageObj.dir == 'desc' }">
                        PROFIT $
                      </div>
                    </th>     
                    <th>
                      <div class="sorting nowrap"
                          ng-click="orderByJobList('profitPercentage')"
                          ng-class="{'sorting_asc': pageObj.column == 'profitPercentage' && pageObj.dir == 'asc', 'sorting_desc': pageObj.column == 'profitPercentage' && pageObj.dir == 'desc' }">
                        PROFIT %
                      </div>
                    </th>                
                    <th></th>
                  </tr>
                </thead>
                <tbody dt-rows ng-repeat="payment in profitReportObj.list" >
                  <tr>
                    <td colspan="8" class="border-td" style="background: #fff;"></td>
                  </tr>
                  <tr class="text-center">
                    <td class="left-td"></td>

                    <td class="text-left"><div class="h-2x"><strong>{{payment.displayName}}</strong></div> <span class="h-0-5x">{{payment.address}}</span></td>
                    <td ng-class="{'clr-red': payment.totalAmount < 0}">{{payment.totalAmount | currency }}</td>
                    <td ng-class="{'clr-red': payment.chemSpend < 0}">{{payment.chemSpend | currency }}</td>
                    <td ng-class="{'clr-red': payment.techPay < 0}">{{payment.techPay | currency }}</td>                    
                    <td ng-class="{'clr-red': payment.profit < 0}">{{payment.profit | currency }}</td>  
                    <td ng-class="{'clr-red': payment.profitPercentage < 0}">{{payment.profitPercentage == null ? '0%' : payment.profitPercentage+'%'}}</td>  

                    <td class="right-td"></td>                    
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="paging-warp container-fluid">
              <div class="row p-t10">
                <div class="col-md-4 text-left p-l20 p-b10">
                    Showing 
                    {{profitReportObj.list.length > 0 ? (pageObj.totalPage == pageObj.currentPage-1 ? (pageObj.totalRecord-profitReportObj.list.length)+1 : (pageObj.currentPage > 1 ? ((pageObj.currentPage-1)*profitReportObj.list.length)+1 : 1)) : 0 }} 
                    to 
                    {{ profitReportObj.list.length > 0 ? (pageObj.totalPage == pageObj.currentPage-1 ? pageObj.totalRecord : pageObj.page*profitReportObj.list.length) : 0 }}  
                    of 
                    {{pageObj.totalRecord}} properties          
                  
                  
                </div>  
                
                <div class="col-md-8">
                  <div class="pagination m-t0">                  
                    <paging
                    page="pageObj.page" page-size="pageObj.limit" total="pageObj.totalRecord" text-first="First"
                    text-last="Last" text-next="Next" text-prev="Prev"
                    paging-action="goToListPage(page)"
                    show-prev-next="true" show-first-last="true"> </paging>                  
                      
                  </div>
                </div>
              </div>
            </div>
  
  
          </div>
    </div> 
</div> 
<script type="text/ng-template" id="sentReportEmailPopupProfitReport.html">
  <div class="dataTables_wrapper modal-box common-popup add-service-level-popup" style="width:420px"> 
     <div class="popup-header">
        <span class="heading">Create Report</span>
        <div class="popup-close" ng-click="closeThisDialog('')"><i class="fa fa-times-circle" aria-hidden="true"></i></div>
     </div>  
     <form class="set-chem-form" name="sentReportEmailForm" autocomplete="off" ng-submit="sentReportEmailForm.$valid && sendReport()" novalidate>      
        <div class="detail-box">         
        <div class="grid text-left box" >         
           <error ng-if="sentReportEmailForm.$submitted && sentReportEmailForm.emailId.$invalid" message="Please enter a valid email."></error>
           <error ng-if="reportPageErrorMsg" message="{{reportPageErrorMsg}}"></error>
           <success ng-if="reportPagereportGeneratingProcessStart" message="Report will be sent to provided email address."></success>
           <div class="col-12 sent-email-report-message">
            Where should we send the report when it's ready? <br> (large reports can take a while)
           </div>
           <div class="col-12-12">                 
              <div class="formGroup">
                    <label>Email Address</label>
                    <input 
                       type="email" 
                       autocomplete="off" 
                       class="form-control" 
                       ng-model="reportPageSentReportEmailModel.email" 
                       placeholder="Email Address" 
                       name="emailId" 
                       ng-maxlength="100" 
                       ng-minlength="6" 
                       ng-disabled="reportPageIsReportSending"
                       ng-pattern='/^[^<>()[\]\\,;:\%#^\s@\"$&!@]+@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z0-9\d-_]+\.)+[a-zA-Z\d-_]{2,}))$/' 
                       ng-class="{'has-error': sentReportEmailForm.$submitted && sentReportEmailForm.emailId.$invalid }"
                       required                         
                    />
              </div>     
           </div>
        </div>      
        <div class="text-center p-t20">
           <button class="add-button add-button-report-send" ng-click="closeThisDialog()" ng-disabled="reportPageIsReportSending" type="button">CANCEL</button>
           <span class="p-l10"><button class="add-button add-button-report-send" ng-disabled="reportPageIsReportSending" type="submit" ng-click="sentReportEmailForm.submitAttempt=true;" >SEND REPORT</button></span>            
        </div>        
        </div>
     </form> 
  
  </div>
  </script>